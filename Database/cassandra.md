# 安装

## Docker 安装 Cassandra
1. 拉取 Cassandra 镜像
    ```bash
    docker pull cassandra:latest
    ```
2. 运行 Cassandra 容器
    ```bash
    docker run --name my-cassandra -d cassandra:latest
    ```
3. 进入 Cassandra 容器
    ```bash
    docker exec -it my-cassandra bash
    ```
4. 连接到 Cassandra shell
    ```bash
    cqlsh
    ```

# 理论
## 什么是 Cassandra

Apache Cassandra 是一个开源的分布式 NoSQL 数据库系统，最初由 Facebook 开发。它以高可用性、可扩展性和容错性著称，适用于处理大规模结构化数据。Cassandra 采用无中心化的对等架构，支持多数据中心复制，能够实现无单点故障的数据存储。其数据模型基于宽列存储，适合写密集型和高吞吐量的应用场景，如物联网、日志收集和实时分析等。

**主要特点：**
- 分布式与去中心化架构
- 高可用性与容错性
- 可横向扩展
- 支持多数据中心复制
- 灵活的 Schema 设计

## 核心概念

- **节点（Node）**：Cassandra 集群中的单个服务器。
- **集群（Cluster）**：由多个节点组成的集合，协同存储和管理数据。
- **数据中心（Data Center）**：节点的逻辑分组，通常对应物理位置或用途。
- **键空间（Keyspace）**：类似于关系型数据库的数据库，定义数据的复制策略。
- **表（Table）**：存储数据的结构，类似于关系型数据库的表。
- **分区键（Partition Key）**：决定数据分布到哪个节点的键。
- **列族（Column Family）**：Cassandra 的表结构，支持宽列存储。
- **一致性级别（Consistency Level）**：控制读写操作的数据一致性要求。

在 Cassandra 中，“节点（Node）”通常指的是集群中的一台服务器（物理机或虚拟机）。每个节点都运行 Cassandra 实例，负责存储和管理部分数据。你可以把“一台电脑 = 一个节点”理解为最常见的部署方式。每个节点之间是对等的，没有主从之分。多个节点组成集群，共同实现数据的分布式存储和高可用性

## NoSQL和关系型数据库的区别

两者设计哲学就完全不同。关系型数据库为`数据一致性`而生，而 NoSQL 数据库为`大规模和高可用性`而生。

### 数据模型
- 关系型数据库使用`表格形式存储数据`，数据之间通过外键建立关系；NoSQL 数据库（如 Cassandra）采用灵活的键值对、文档、列族等多种数据模型，适合处理非结构化或半结构化数据。

### 扩展性

关系型数据库通常采用垂直扩展（增加单个服务器的资源）来提升性能，扩展性有限；NoSQL 数据库设计为水平扩展（增加更多服务器节点），能够轻松处理大规模数据和高并发请求。

- NoSQL (水平扩展 / Scale-Out):

    - 设计理念：NoSQL 数据库从一开始就被设计成一个分布式系统。它假设系统会运行在多台廉价的普通服务器上，而不是一台昂贵的超级服务器上。
    - 实现方式：它通过`数据分片（Sharding)`的机制，自动地将数据集合打散，分布到不同的服务器节点上。当一个新节点加入集群时，数据库会自动进行数据迁移和负载均衡。对应用层来说，这个过程通常是透明的。你只需要不断地增加服务器节点，就能线性地提升整个集群的存储能力和处理能力。
- SQL (垂直扩展 / Scale-Up):
    - 设计理念：传统的关系型数据库被设计为在单一服务器上运行，通过保障该服务器内部的 ACID（原子性、一致性、隔离性、持久性）来确保数据的强一致性。
    - 扩展方式：当性能不足时，首选方案是增强这台服务器的硬件，比如增加更强的 CPU、更大的内存、更快的硬盘。但这种方式很快会遇到物理和成本的瓶颈——服务器硬件的性能提升不是无限的，而且价格会指数级增长。
    - 水平扩展的挑战：虽然关系型数据库也可以通过分库分表等方式进行水平扩展，但这通常非常复杂，需要应用层做大量的改造和适配工作，并且会破坏数据库原生的一些特性（如跨库的事务、Join 操作等），管理和维护成本极高。

### 数据一致性
关系型数据库强调强一致性，确保所有节点的数据始终保持同步；NoSQL 数据库通常采用最终一致性模型，允许在一定时间内数据不一致，以换取更高的可用性和性能。

#### CAP定理
CAP 定理（Consistency, Availability, Partition Tolerance）是分布式系统设计中的核心理论，由 Eric Brewer 提出，后来被证明为定理。它描述了在分布式系统中，无法同时完全满足`一致性`、`可用性`和`分区容忍性`，最多只能满足其中两个。

- 一致性 (Consistency): 所有节点在同一时间看到的数据是一致的。也就是说，一旦数据被写入，所有后续的读取操作都能读到最新的值。

- 可用性 (Availability): 每个请求都会在有限的时间内得到响应，无论响应是成功还是失败。系统始终对读写请求保持可用状态。

- 分区容忍性 (Partition Tolerance): 系统能够继续运行，即使网络分区（节点之间的通信失败）发生。也就是说，系统可以容忍部分节点或网络的故障，而不会导致整个系统崩溃。

关系型数据库（单机）：倾向于 CA（强一致性 + 可用性），因为没有分区问题。

NoSQL 分布式数据库：倾向于 AP（高可用 + 分区容忍），采用最终一致性。

#### ACID 原则
关系型数据库的核心是保证数据的`强一致性`。它们通过一个被称为 ACID 的模型来确保这一点。


- 原子性 (Atomicity): 事务是一个不可分割的工作单元。事务中的所有操作要么全部成功，要么全部失败回滚。不会出现只执行了一部分操作的情况。
    - 例子： 在银行转账中，“从A账户扣款”和“向B账户存款”这两个操作必须捆绑在一个事务里。如果存款失败，扣款操作也必须撤销。

- 一致性 (Consistency): 事务必须使数据库从一个一致的状态转变到另一个一致的状态。事务执行前后，数据库的完整性约束（如主键、外键、非空等）没有被破坏。
    - 例子： 如果规定账户余额不能为负，那么任何导致余额变为负数的转账事务都不会被允许提交。

- 隔离性 (Isolation): 多个并发事务同时执行时，一个事务的执行不应被其他事务干扰。每个事务都感觉不到其他事务的存在。数据库通过锁机制和不同的隔离级别（如读未提交、读已提交、可重复读、串行化）来实现这一点。
    - 例子： 当你查询账户余额时，不会看到另一个尚未完成的转账事务的中间状态（比如钱已经从A扣了，但还没到B）。

- 持久性 (Durability): 一旦事务被成功提交，它对数据库的改变就是永久性的。即使系统发生故障（如断电或崩溃），已提交的数据也不会丢失。

关系型数据库通过严格遵守 ACID 原则，确保数据的完整性和一致性。这意味着：

- 写后即读：一旦数据写入（事务提交）成功，任何后续的读取操作都保证能读到这个最新的值。
- 在分布式环境下，为了保证强一致性，系统通常会采用“两阶段提交”（2PC）等协议，但这会牺牲一部分性能和可用性。

#### BASE 原则
NoSQL 通常优先考虑可用性（Availability）和分区容错性（Partition Tolerance），而在一致性上做出妥协。它们遵循的是 BASE 模型。

BASE 是对 ACID 的权衡，代表了三个概念：

- 基本可用 (Basically Available): 系统保证在任何时候都能响应请求，即使出现部分节点故障。它允许返回可能不是最新的数据，但不会返回错误。

- 软状态 (Soft State): 不同节点之间的状态可以不同步，数据可能在一段时间内处于不一致状态。也是说，数据在不同节点之间同步不是实时的，可以延迟。

- 最终一致性 (Eventually Consistent): 这是核心思想。系统不保证在数据写入后，所有的读取操作都能立即读到最新值。但它保证，如果在数据写入后没有新的更新，系统中的所有副本最终会达到一致的状态。这个“最终”可能需要几毫秒到几秒不等。

例子： 你在社交媒体上发布了一张照片，你的一个朋友可能立即就看到了，但另一个在不同地理位置的朋友可能需要几秒钟后才能看到。在这几秒的“不一致窗口”内，系统仍然是可用的。

### 查询能力
Cassandra 使用 CQL（Cassandra Query Language）进行数据操作，语法类似 SQL，但不支持复杂的 JOIN 和事务操作，适合大规模数据的快速读写。

其实这也是因为NOSQL使用不同的数据模型，对应的查询能力也不同。总体来说：关系型数据库擅长复杂查询和事务分析，NoSQL 更适合简单、高速查询和分布式场景，但在 JOIN 和复杂聚合上能力有限。

## Cassandra 架构

TODO:分布式架构，等用到了再看。

## Cassandra 数据模型

Cassandra 使用Column-Family(列族) 数据模型，类似于关系型数据库的表格结构，但更灵活。主要概念包括： Keyspace（键空间）、Column-Family（表）、Row（行）、Column（列）等。

* Keyspace（键空间）：类似于关系型数据库的数据库，定义数据的复制策略。
* Column-Family（表）：存储数据的结构，类似于关系型数据库的表。
* Row（行）：表中的一条记录，由一个唯一的分区键标识。
* Column（列）：行中的数据字段，也是最小数据存储单元，包含（列名、值、时间戳）。

### 整体结构

![alt text](cassandraPIC/keyspace.jpg)

最外层是 Keyspace，类似于关系型数据库的数据库。每个 Keyspace 包含多个 Column-Family（表）。

其中Keyspace可以定义数据的复制因子和副本放置策略：
* 复制因子： 指定数据在集群中复制的节点数。例如，复制因子为3表示每条数据会存储在3个不同的节点上，以提高容错性和可用性。
* 副本放置策略： 定义数据副本在集群中的分布方式。

每个Keyspace下包含多个 Column-Family（表），其中每个Column Family可以类别RDBMS中的表,其结构如下：

![alt text](cassandraPIC/cassandra_column_family.jpg)

Column-Family（表）包含多行（Row），每行由一个唯一的分区键（Partition Key）标识。每行包含多个列（Column），每列由列名、值和时间戳组成:

* 分区键（Partition Key）： 决定数据分布到哪个节点的键。Cassandra 根据分区键的哈希值将数据分布到集群中的不同节点。它是由一个或多个列组成的复合键。
* 列（Column）： 行中的数据字段，也是最小数据存储单元。每列包含以下三个部分：
    * 列名（Column Name）： 列的标识符，可以是字符串或其他数据类型。
    * 值（Value）： 列存储的实际数据，可以是各种数据类型，如字符串、整数、布尔值等。
    * 时间戳（Timestamp）： 每列都有一个时间戳，用于记录该列最后一次更新的时间。Cassandra 使用时间戳来解决数据冲突，确保最新的数据被保留。
* 超级列（Super Column）： 是一种特殊的列，包含多个子列(column)。超级列用于实现更复杂的数据结构，但在现代 Cassandra 版本中不常用。

# 使用
## 基本操作

Cassandra 使用 CQL（Cassandra Query Language）进行数据操作，语法类似 SQL。

**创建键空间：**
```sql
CREATE KEYSPACE my_keyspace WITH REPLICATION = {
    'class': 'SimpleStrategy',
    'replication_factor': 3
};
```

**创建表：**
```sql
CREATE TABLE my_keyspace.users (
    user_id UUID PRIMARY KEY,
    name TEXT,
    age INT
);
```

**插入数据：**
```sql
INSERT INTO my_keyspace.users (user_id, name, age)
VALUES (uuid(), 'Alice', 30);
```

**查询数据：**
```sql
SELECT * FROM my_keyspace.users WHERE user_id = ...;
```

**更新数据：**
```sql
UPDATE my_keyspace.users SET age = 31 WHERE user_id = ...;
```

**删除数据：**
```sql
DELETE FROM my_keyspace.users WHERE user_id = ...;
```

**查看表结构：**
```sql
DESCRIBE TABLE my_keyspace.users;
```
该命令会显示表的列、主键、索引等详细结构信息。

## 列的更改

Cassandra 支持对表的列进行更改。你可以使用 `ALTER TABLE` 语句添加新列或删除已有列，但不能直接修改已有列的数据类型（需要先删除再添加）。常见操作如下：

**添加列：**
```sql
ALTER TABLE my_keyspace.users ADD email TEXT;
```

**删除列：**
```sql
ALTER TABLE my_keyspace.users DROP age;
```

注意：删除列后，已有数据中的该列内容会被标记为删除（Tombstone），实际物理删除会在后台进行。